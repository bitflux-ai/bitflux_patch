
---
- name: role to install tarball bitflux collector
  hosts: all
  tasks:
  - name: Push to remote bitflux collector
    copy:
      src: ../../latest.tar.gz
      dest: /tmp/latest.tar.gz
  - name: Untar bitflux collector
    shell: mkdir /tmp/latest; cd /tmp/latest/; tar xvf /tmp/latest.tar.gz
    args:
      warn: false
  - name: Install bitflux collector
    shell: cd /tmp/latest/; apt install -y $(ls *.deb | sed 's/^/.\//')
  - name: Change license key
    shell: "sed -i \"s/licensekey.*/licensekey={{ license }}/g\" $( if [ -f '/opt/bitflux/config/bitflux/bitfluxcollector.conf' ]; then echo '/opt/bitflux/config/bitflux/bitfluxcollector.conf'; else echo '/etc/systemd/system/bitflux.service'; fi )"
  - name: Change deviceid
    shell: "sed -i \"s/deviceid.*/deviceid={{ deviceid }}/g\" $( if [ -f '/opt/bitflux/config/bitflux/bitfluxcollector.conf' ]; then echo '/opt/bitflux/config/bitflux/bitfluxcollector.conf'; else echo '/etc/systemd/system/bitflux.service'; fi )"
  - name: reboot
    reboot:
